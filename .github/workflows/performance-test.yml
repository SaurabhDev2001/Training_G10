name: Performance Testing
on:
  workflow_call:

jobs:
  performance-test:
    runs-on: ubuntu-latest
    steps:
      - name: Download Build Output
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Install BenchmarkDotNet
        run: dotnet add package BenchmarkDotNet --version 0.13.12

      - name: Run Performance Tests
        run: |
          # Create a simple benchmark if none exists
          if [ ! -f "Benchmarks.cs" ]; then
            cat > Benchmarks.cs << 'EOF'
          using BenchmarkDotNet.Attributes;
          using BenchmarkDotNet.Running;

          [MemoryDiagnoser]
          public class CalculatorBenchmarks
          {
              [Benchmark]
              public int AddNumbers() => 5 + 3;
              
              [Benchmark]
              public int MultiplyNumbers() => 5 * 3;
          }

          public class Program
          {
              public static void Main(string[] args)
              {
                  BenchmarkRunner.Run<CalculatorBenchmarks>();
              }
          }
          EOF
          fi
          dotnet run -c Release

      - name: Upload Performance Results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: BenchmarkDotNet.Artifacts/