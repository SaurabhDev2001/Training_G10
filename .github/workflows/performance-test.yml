name: Performance Testing
on:
  workflow_call:

jobs:
  performance-test:
    runs-on: ubuntu-latest
    steps:
      - name: Download Source Code
        uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .

      - name: Download Build Output
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Run Performance Tests
        run: |
          PROJECT_FILE=$(find . -name "*.csproj" | grep -v Tests | head -n 1)
          if [ -z "$PROJECT_FILE" ]; then
            echo "No project file found, creating benchmark project"
            dotnet new console -n BenchmarkApp
            cd BenchmarkApp
            dotnet add package BenchmarkDotNet --version 0.13.12
            
            cat > Program.cs << 'EOF'
          using BenchmarkDotNet.Attributes;
          using BenchmarkDotNet.Running;

          [MemoryDiagnoser]
          public class CalculatorBenchmarks
          {
              [Benchmark]
              public int AddNumbers() => 5 + 3;
              
              [Benchmark]
              public int MultiplyNumbers() => 5 * 3;
          }

          public class Program
          {
              public static void Main(string[] args)
              {
                  BenchmarkRunner.Run<CalculatorBenchmarks>();
              }
          }
          EOF
            dotnet run -c Release
            cd ..
          else
            echo "Found project: $PROJECT_FILE"
            dotnet add "$PROJECT_FILE" package BenchmarkDotNet --version 0.13.12
            
            # Create benchmark class for existing project
            cat > CalculatorBenchmarks.cs << 'EOF'
          using BenchmarkDotNet.Attributes;
          using BenchmarkDotNet.Running;

          [MemoryDiagnoser]
          public class CalculatorBenchmarks
          {
              [Benchmark]
              public int AddNumbers() => 5 + 3;
              
              [Benchmark]
              public int MultiplyNumbers() => 5 * 3;
              
              [Benchmark]
              public double DivideNumbers() => 10.0 / 2.0;
          }

          public class BenchmarkProgram
          {
              public static void RunBenchmarks()
              {
                  BenchmarkRunner.Run<CalculatorBenchmarks>();
              }
          }
          EOF
            
            # Create a simple console app to run benchmarks
            dotnet new console -n BenchmarkRunner --force
            cd BenchmarkRunner
            dotnet add package BenchmarkDotNet --version 0.13.12
            cp ../CalculatorBenchmarks.cs .
            
            cat > Program.cs << 'EOF'
          using BenchmarkDotNet.Running;

          class Program
          {
              static void Main(string[] args)
              {
                  BenchmarkRunner.Run<CalculatorBenchmarks>();
              }
          }
          EOF
            
            dotnet run -c Release
            cd ..
          fi

      - name: Create Performance Results Directory
        run: |
          if [ ! -d "BenchmarkDotNet.Artifacts" ]; then
            mkdir -p BenchmarkDotNet.Artifacts
            echo "Performance test summary: No benchmarks executed" > BenchmarkDotNet.Artifacts/summary.txt
          fi

      - name: Upload Performance Results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: 'BenchmarkDotNet.Artifacts/'
          if-no-files-found: ignore